<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scholar Article Summarizer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #2c3e50;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2.4em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.85);
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 300;
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .nav-bar a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .nav-bar a:hover, .nav-bar a.active {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: rgba(255,255,255,0.6);
        }

        /* Search Panel */
        .search-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .search-panel h2 {
            font-size: 1.2em;
            color: #1a5276;
            margin-bottom: 15px;
        }

        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .search-row input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 10px 16px;
            border: 2px solid #dde;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-row input:focus {
            border-color: #2980b9;
        }

        .search-row select {
            padding: 10px 16px;
            border: 2px solid #dde;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2980b9, #3498db);
            color: white;
        }

        .btn-primary:hover { background: linear-gradient(135deg, #2471a3, #2980b9); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover { background: #d5dbdb; }

        /* Preset Tags */
        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .preset-tag {
            padding: 5px 14px;
            background: #eaf2f8;
            color: #2471a3;
            border-radius: 20px;
            font-size: 0.85em;
            cursor: pointer;
            border: 1px solid #aed6f1;
            transition: all 0.2s;
        }

        .preset-tag:hover {
            background: #2980b9;
            color: white;
            border-color: #2980b9;
        }

        /* Status */
        .status-bar {
            background: #fef9e7;
            border: 1px solid #f9e79f;
            border-radius: 8px;
            padding: 12px 18px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .status-bar.visible { display: flex; }
        .status-bar.error { background: #fdedec; border-color: #f5b7b1; }
        .status-bar.success { background: #eafaf1; border-color: #abebc6; }

        .spinner {
            width: 20px; height: 20px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #2980b9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Results */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-header h2 {
            color: white;
            font-size: 1.4em;
        }

        .results-count {
            color: rgba(255,255,255,0.8);
            font-size: 0.95em;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
        }

        .sort-btn {
            padding: 5px 14px;
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sort-btn:hover, .sort-btn.active {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        /* Article Cards */
        .article-card {
            background: white;
            border-radius: 12px;
            padding: 22px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #2980b9;
        }

        .article-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .article-card.high-relevance { border-left-color: #27ae60; }
        .article-card.medium-relevance { border-left-color: #f39c12; }
        .article-card.low-relevance { border-left-color: #95a5a6; }

        .article-title {
            font-size: 1.15em;
            font-weight: 600;
            color: #1a5276;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .article-title a {
            color: inherit;
            text-decoration: none;
        }

        .article-title a:hover { color: #2980b9; text-decoration: underline; }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
            font-size: 0.88em;
            color: #666;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .meta-icon { font-size: 1em; }

        .article-abstract {
            color: #444;
            font-size: 0.93em;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .article-abstract.collapsed {
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }

        .article-abstract.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, white);
        }

        .toggle-abstract {
            color: #2980b9;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: 500;
        }

        .toggle-abstract:hover { text-decoration: underline; }

        .relevance-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.78em;
            font-weight: 600;
        }

        .relevance-high { background: #eafaf1; color: #1e8449; }
        .relevance-medium { background: #fef9e7; color: #b7950b; }
        .relevance-low { background: #f2f3f4; color: #717d7e; }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .keyword-tag {
            padding: 2px 10px;
            background: #eaf2f8;
            color: #2471a3;
            border-radius: 10px;
            font-size: 0.78em;
        }

        /* Endnote Import */
        .endnote-section {
            background: white;
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .endnote-section h3 {
            color: #1a5276;
            margin-bottom: 10px;
            font-size: 1.05em;
        }

        .file-drop {
            border: 2px dashed #aed6f1;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            color: #7fb3d8;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-drop:hover, .file-drop.dragover {
            border-color: #2980b9;
            background: #eaf2f8;
            color: #2980b9;
        }

        .file-drop input { display: none; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.7);
        }

        .empty-state .icon { font-size: 3em; margin-bottom: 15px; }
        .empty-state p { font-size: 1.1em; margin-bottom: 5px; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover, .page-btn.active {
            background: rgba(255,255,255,0.3);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 1.6em; }
            .search-row { flex-direction: column; }
            .search-row input, .search-row select { min-width: unset; }
            .article-meta { flex-direction: column; gap: 4px; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Scholar Article Summarizer</h1>
    <p class="subtitle">Relevante Forschungsartikel finden und bewerten</p>

    <!-- Search Panel -->
    <div class="search-panel">
        <h2>Artikelsuche</h2>
        <div class="search-row">
            <input type="text" id="searchInput" placeholder="Suchbegriff eingeben, z.B. &quot;enamel remineralization&quot;" />
            <select id="yearFilter">
                <option value="">Alle Jahre</option>
                <option value="2026">2026</option>
                <option value="2025" selected>Ab 2025</option>
                <option value="2024">Ab 2024</option>
                <option value="2023">Ab 2023</option>
                <option value="2020">Ab 2020</option>
            </select>
            <select id="sortOrder">
                <option value="relevance">Relevanz</option>
                <option value="cited_by_count">Zitierungen</option>
                <option value="publication_date">Datum</option>
            </select>
            <button class="btn btn-primary" id="searchBtn" onclick="performSearch()">Suchen</button>
        </div>

        <p style="font-size:0.85em; color:#888; margin-top:6px;">
            Vordefinierte Suchen:
        </p>
        <div class="presets" id="presetTags"></div>
    </div>

    <!-- Endnote Import -->
    <div class="endnote-section">
        <h3>Endnote / RIS Import</h3>
        <div class="file-drop" id="fileDrop" onclick="document.getElementById('risFile').click()">
            <input type="file" id="risFile" accept=".ris,.xml,.bib,.enw" onchange="handleFileImport(event)" />
            <p>RIS-, XML- oder BibTeX-Datei hierher ziehen oder klicken</p>
            <p style="font-size:0.8em; color:#aaa; margin-top:5px;">Unterstuetzte Formate: .ris, .xml, .bib</p>
        </div>
    </div>

    <!-- Status -->
    <div class="status-bar" id="statusBar">
        <div class="spinner" id="spinner"></div>
        <span id="statusText">Suche laeuft...</span>
    </div>

    <!-- Results -->
    <div id="resultsArea"></div>
</div>

<script>
// ── Config ──────────────────────────────────────────────────────────
const OPENALEX_API = 'https://api.openalex.org/works';
const PER_PAGE = 20;

const PRESET_QUERIES = [
    'tooth enamel remineralization',
    'hydroxyapatite remineralization',
    'fluoride remineralization dental',
    'biomimetic remineralization',
    'CPP-ACP remineralization',
    'bioactive glass dental',
    'calcium phosphate remineralization',
    'dentin remineralization',
    'dental caries prevention',
    'bisphenol BPA dental',
];

const RELEVANCE_KEYWORDS = [
    'remineralization', 'remineralisation', 'enamel', 'dentin', 'dentine',
    'hydroxyapatite', 'fluoride', 'calcium phosphate', 'bioactive glass',
    'cpp-acp', 'tooth repair', 'dental caries', 'demineralization',
    'bisphenol', 'bpa', 'bpt', 'bpf',
];

let allArticles = [];
let currentPage = 1;

// ── Init ────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
    renderPresets();
    setupDragDrop();

    document.getElementById('searchInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') performSearch();
    });
});

function renderPresets() {
    const container = document.getElementById('presetTags');
    container.innerHTML = PRESET_QUERIES.map(q =>
        `<span class="preset-tag" onclick="usePreset('${q}')">${q}</span>`
    ).join('');
}

function usePreset(query) {
    document.getElementById('searchInput').value = query;
    performSearch();
}

// ── OpenAlex API Search ─────────────────────────────────────────────
async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;

    const yearFrom = document.getElementById('yearFilter').value;
    const sort = document.getElementById('sortOrder').value;

    showStatus('loading', `Suche nach "${query}"...`);

    let url = `${OPENALEX_API}?search=${encodeURIComponent(query)}&per_page=${PER_PAGE}&page=1`;

    if (yearFrom) {
        url += `&filter=from_publication_date:${yearFrom}-01-01`;
    }

    // OpenAlex sort: relevance_score, cited_by_count, publication_date
    if (sort === 'cited_by_count') {
        url += '&sort=cited_by_count:desc';
    } else if (sort === 'publication_date') {
        url += '&sort=publication_date:desc';
    }

    // Polite pool: add email for faster responses
    url += '&mailto=scholar-summarizer@example.com';

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`API Fehler: ${response.status}`);

        const data = await response.json();
        const articles = data.results.map(parseOpenAlexWork);

        // Calculate relevance scores
        articles.forEach(a => calculateRelevance(a));
        if (sort === 'relevance') {
            articles.sort((a, b) => b.relevanceScore - a.relevanceScore);
        }

        allArticles = articles;
        currentPage = 1;

        showStatus('success', `${data.meta.count.toLocaleString()} Ergebnisse gefunden, ${articles.length} angezeigt.`);
        renderResults(articles);
    } catch (err) {
        showStatus('error', `Fehler: ${err.message}`);
        console.error(err);
    }
}

function parseOpenAlexWork(work) {
    const authorships = work.authorships || [];
    const authors = authorships.map(a => a.author?.display_name).filter(Boolean);

    let abstract = '';
    if (work.abstract_inverted_index) {
        abstract = reconstructAbstract(work.abstract_inverted_index);
    }

    // Primary source
    const source = work.primary_location?.source;

    return {
        title: work.title || 'Ohne Titel',
        authors: authors,
        abstract: abstract,
        year: work.publication_year || '',
        date: work.publication_date || '',
        journal: source?.display_name || '',
        doi: work.doi || '',
        url: work.doi || work.id || '',
        openAccessUrl: work.open_access?.oa_url || '',
        citations: work.cited_by_count || 0,
        concepts: (work.concepts || []).map(c => c.display_name),
        type: work.type || '',
        relevanceScore: 0,
        matchedKeywords: [],
        source: 'openalex',
    };
}

function reconstructAbstract(invertedIndex) {
    if (!invertedIndex) return '';
    const words = [];
    for (const [word, positions] of Object.entries(invertedIndex)) {
        for (const pos of positions) {
            words[pos] = word;
        }
    }
    return words.join(' ');
}

// ── Relevance Scoring ───────────────────────────────────────────────
function calculateRelevance(article) {
    const text = [
        article.title,
        article.abstract,
        article.concepts.join(' '),
    ].join(' ').toLowerCase();

    let score = 0;
    const matched = [];

    for (const kw of RELEVANCE_KEYWORDS) {
        const kwLower = kw.toLowerCase();
        const regex = new RegExp(kwLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        const matches = text.match(regex);
        if (matches) {
            score += matches.length;
            matched.push(kw);
        }
        // Title bonus
        if (article.title.toLowerCase().includes(kwLower)) {
            score += 3;
        }
    }

    article.relevanceScore = score;
    article.matchedKeywords = matched;
}

// ── Endnote / RIS Import ────────────────────────────────────────────
function setupDragDrop() {
    const drop = document.getElementById('fileDrop');
    drop.addEventListener('dragover', e => {
        e.preventDefault();
        drop.classList.add('dragover');
    });
    drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
    drop.addEventListener('drop', e => {
        e.preventDefault();
        drop.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            handleFileImport({ target: { files: e.dataTransfer.files } });
        }
    });
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        const content = e.target.result;
        const ext = file.name.split('.').pop().toLowerCase();

        let articles = [];
        if (ext === 'ris' || ext === 'enw') {
            articles = parseRIS(content);
        } else if (ext === 'xml') {
            articles = parseEndnoteXML(content);
        } else if (ext === 'bib') {
            articles = parseBibTeX(content);
        }

        if (articles.length === 0) {
            showStatus('error', `Keine Artikel in ${file.name} gefunden.`);
            return;
        }

        articles.forEach(a => {
            a.source = 'endnote';
            calculateRelevance(a);
        });
        articles.sort((a, b) => b.relevanceScore - a.relevanceScore);

        allArticles = articles;
        currentPage = 1;
        showStatus('success', `${articles.length} Artikel aus "${file.name}" importiert.`);
        renderResults(articles);
    };
    reader.readAsText(file);
}

function parseRIS(text) {
    const articles = [];
    let current = {};

    const tagMap = {
        'TI': 'title', 'T1': 'title',
        'AU': 'authors', 'A1': 'authors',
        'AB': 'abstract', 'N2': 'abstract',
        'PY': 'year', 'Y1': 'year',
        'JO': 'journal', 'JF': 'journal', 'T2': 'journal',
        'DO': 'doi',
        'UR': 'url',
        'KW': 'keywords',
    };

    for (const line of text.split('\n')) {
        const match = line.match(/^([A-Z][A-Z0-9])\s{2}-\s(.*)$/);
        if (match) {
            const [, tag, value] = match;
            if (tag === 'ER') {
                if (current.title) articles.push(finalizeImported(current));
                current = {};
            } else if (tag === 'TY') {
                current.type = value.trim();
            } else if (tagMap[tag]) {
                const field = tagMap[tag];
                if (field === 'authors') {
                    current.authors = current.authors || [];
                    current.authors.push(value.trim());
                } else if (field === 'keywords') {
                    current.keywords = current.keywords || [];
                    current.keywords.push(value.trim());
                } else {
                    current[field] = value.trim();
                }
            }
        }
    }
    if (current.title) articles.push(finalizeImported(current));
    return articles;
}

function parseEndnoteXML(text) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/xml');
    const articles = [];

    for (const record of doc.querySelectorAll('record, Record')) {
        const get = (sel) => {
            for (const s of sel.split(',')) {
                const el = record.querySelector(s.trim());
                if (el?.textContent) return el.textContent.trim();
            }
            return '';
        };

        const authorEls = record.querySelectorAll('author, Author');
        const authors = Array.from(authorEls).map(a => a.textContent.trim()).filter(Boolean);
        const kwEls = record.querySelectorAll('keyword, Keyword');
        const keywords = Array.from(kwEls).map(k => k.textContent.trim()).filter(Boolean);

        const article = {
            title: get('title, Title'),
            authors: authors,
            abstract: get('abstract, Abstract'),
            year: get('year, Year, dates year'),
            journal: get('secondary-title, full-title, periodical title'),
            doi: get('electronic-resource-num'),
            url: get('web-urls url, urls related-urls url'),
            keywords: keywords,
        };

        if (article.title) articles.push(finalizeImported(article));
    }
    return articles;
}

function parseBibTeX(text) {
    const articles = [];
    const entries = text.split(/(?=@\w+\{)/);

    for (const entry of entries) {
        if (!entry.trim()) continue;
        const get = (field) => {
            const re = new RegExp(`${field}\\s*=\\s*[{"]([^}"]*)[}"]`, 'i');
            const m = entry.match(re);
            return m ? m[1].trim() : '';
        };

        const authorsRaw = get('author');
        const authors = authorsRaw ? authorsRaw.split(/\s+and\s+/) : [];

        const article = {
            title: get('title'),
            authors: authors,
            abstract: get('abstract'),
            year: get('year'),
            journal: get('journal') || get('booktitle'),
            doi: get('doi'),
            url: get('url'),
            keywords: [],
        };

        if (article.title) articles.push(finalizeImported(article));
    }
    return articles;
}

function finalizeImported(article) {
    return {
        title: article.title || 'Ohne Titel',
        authors: article.authors || [],
        abstract: article.abstract || '',
        year: article.year || '',
        date: '',
        journal: article.journal || '',
        doi: article.doi || '',
        url: article.doi ? `https://doi.org/${article.doi}` : (article.url || ''),
        openAccessUrl: '',
        citations: 0,
        concepts: article.keywords || [],
        type: article.type || '',
        relevanceScore: 0,
        matchedKeywords: [],
        source: 'import',
    };
}

// ── Render ──────────────────────────────────────────────────────────
function renderResults(articles) {
    const area = document.getElementById('resultsArea');

    if (!articles.length) {
        area.innerHTML = `
            <div class="empty-state">
                <div class="icon">&#128218;</div>
                <p>Keine Artikel gefunden.</p>
                <p style="font-size:0.9em">Versuche einen anderen Suchbegriff.</p>
            </div>`;
        return;
    }

    let html = `
        <div class="results-header">
            <h2>Ergebnisse</h2>
            <span class="results-count">${articles.length} Artikel</span>
        </div>`;

    for (const article of articles) {
        const relevanceClass = article.relevanceScore >= 8 ? 'high' :
                               article.relevanceScore >= 3 ? 'medium' : 'low';

        const authorsStr = article.authors.length > 3
            ? article.authors.slice(0, 3).join(', ') + ' et al.'
            : article.authors.join(', ');

        const linkUrl = article.openAccessUrl || article.url || '';
        const titleHtml = linkUrl
            ? `<a href="${linkUrl}" target="_blank" rel="noopener">${escapeHtml(article.title)}</a>`
            : escapeHtml(article.title);

        const abstractId = 'abs-' + Math.random().toString(36).slice(2, 9);
        const hasLongAbstract = article.abstract.length > 250;

        html += `
        <div class="article-card ${relevanceClass}-relevance">
            <div class="article-title">${titleHtml}</div>
            <div class="article-meta">
                <span class="meta-item"><span class="meta-icon">&#128100;</span> ${escapeHtml(authorsStr) || 'Unbekannt'}</span>
                <span class="meta-item"><span class="meta-icon">&#128197;</span> ${article.year || 'k.A.'}</span>
                <span class="meta-item"><span class="meta-icon">&#128214;</span> ${escapeHtml(article.journal) || 'k.A.'}</span>
                <span class="meta-item"><span class="meta-icon">&#128279;</span> ${article.citations} Zitierungen</span>
                <span class="relevance-badge relevance-${relevanceClass}">Score: ${article.relevanceScore.toFixed(0)}</span>
            </div>

            ${article.abstract ? `
                <div class="article-abstract ${hasLongAbstract ? 'collapsed' : ''}" id="${abstractId}">
                    ${escapeHtml(article.abstract)}
                </div>
                ${hasLongAbstract ? `<span class="toggle-abstract" onclick="toggleAbstract('${abstractId}', this)">Mehr anzeigen</span>` : ''}
            ` : '<p style="color:#aaa;font-size:0.9em;">Kein Abstract verfuegbar.</p>'}

            ${article.matchedKeywords.length ? `
                <div class="keyword-tags">
                    ${article.matchedKeywords.map(k => `<span class="keyword-tag">${escapeHtml(k)}</span>`).join('')}
                </div>
            ` : ''}
        </div>`;
    }

    area.innerHTML = html;
}

function toggleAbstract(id, btn) {
    const el = document.getElementById(id);
    el.classList.toggle('collapsed');
    btn.textContent = el.classList.contains('collapsed') ? 'Mehr anzeigen' : 'Weniger anzeigen';
}

// ── Helpers ─────────────────────────────────────────────────────────
function showStatus(type, message) {
    const bar = document.getElementById('statusBar');
    const spinner = document.getElementById('spinner');
    const text = document.getElementById('statusText');

    bar.className = 'status-bar visible';
    if (type === 'error') bar.classList.add('error');
    if (type === 'success') bar.classList.add('success');

    spinner.style.display = type === 'loading' ? 'block' : 'none';
    text.textContent = message;

    if (type !== 'loading') {
        setTimeout(() => { bar.classList.remove('visible'); }, 6000);
    }
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>

</body>
</html>
